# Story 3.2: Intelligent Endpoint Indexing

## Story Overview
**Epic**: Epic 3 - Search & Discovery Engine
**Story ID**: 3.2
**Story Type**: Core Feature
**Complexity**: High
**Sprint**: TBD

## User Story
As a system,
I want to create comprehensive searchable documents for each API endpoint,
So that AI agents can discover endpoints through multiple contextual pathways.

## Story Context

### Business Value
- Enables multi-dimensional endpoint discovery beyond simple path matching
- Provides rich contextual information for AI agents to understand endpoint purpose
- Delivers comprehensive search capability across all aspects of API endpoints
- Improves search relevance by capturing complete endpoint semantic context

### Dependencies
**Depends On:**
- Story 3.1: Core Search Infrastructure Setup (search engine and indexing framework)
- Story 1.3: Schema Normalization Engine (normalized endpoint and parameter structure)
- Story 1.4: Basic Storage Layer Implementation (complete endpoint data in database)

**Enables:**
- Story 3.3: Advanced Search Query Processing (sophisticated queries on rich endpoint documents)
- Story 3.4: Search Result Optimization and Filtering (enhanced filtering on comprehensive metadata)
- Enhanced searchEndpoints functionality in Story 2.2

### Technical Context
**Existing System Integration:**
- Integrates with: Search index infrastructure from Story 3.1, normalized endpoint data
- Technology: Python with advanced text processing, semantic content extraction
- Follows pattern: Data processing pipelines from normalization engine, indexing patterns
- Touch points: Endpoint tables, parameter definitions, response schemas, security requirements

## Acceptance Criteria

### Functional Requirements
1. **Comprehensive Endpoint Path Indexing**
   - Index endpoint paths with path parameter extraction and normalization
   - Handle path parameter variations: `/users/{id}`, `/users/{user_id}`, `/users/:id`
   - Extract and index path segments for hierarchical search (e.g., `/api/v1/users` → ["api", "v1", "users"])
   - Support REST resource pattern recognition and indexing (resource names, operations)

2. **Operation Description and Metadata Indexing**
   - Index OpenAPI operation summaries and descriptions with full-text search capability
   - Extract and index operation tags for categorical search and filtering
   - Index operation IDs and external documentation links when available
   - Process and index deprecated operation flags and version information

3. **Parameter Comprehensive Indexing**
   - Index all parameter types: path, query, header, cookie parameters
   - Include parameter names, descriptions, types, and constraint information
   - Index parameter examples and default values for search context
   - Handle parameter dependency relationships and conditional requirements

### Integration Requirements
4. **Response Schema Integration**
   - Include response schema information in endpoint search documents
   - Index response content types and status code information
   - Extract response schema field names and types for searchability
   - Link response schemas to searchable schema components for cross-references

5. **Security Requirements Integration**
   - Extract and index security requirements for endpoint-specific authentication discovery
   - Index security scheme types: bearer, apiKey, oauth2, openIdConnect
   - Include security scope information for fine-grained access control search
   - Handle optional vs. required security requirements in search context

6. **Composite Document Construction**
   - Create unified search documents capturing complete endpoint semantic context
   - Combine path, operation, parameter, response, and security information coherently
   - Maintain document structure optimized for BM25 relevance ranking
   - Include metadata for search result enhancement and filtering

### Quality Requirements
7. **Content Extraction Accuracy**
   - Extract 100% of searchable content from normalized endpoint data
   - Preserve semantic relationships between endpoint components in search documents
   - Handle edge cases: missing descriptions, optional parameters, complex security schemes
   - Validate document completeness against original OpenAPI specification

8. **Search Document Quality**
   - Optimize document structure for search relevance and ranking effectiveness
   - Balance document comprehensiveness with search performance requirements
   - Include appropriate keyword density for effective BM25 scoring
   - Maintain document consistency across different endpoint types and patterns

9. **Indexing Performance and Scalability**
   - Process large numbers of endpoints efficiently (1000+ endpoints per API)
   - Memory-efficient document creation for enterprise-scale API documentation
   - Batch processing optimization for minimal indexing time impact
   - Support for incremental endpoint indexing when API documentation updates

## Technical Implementation Notes

### Endpoint Document Structure
```python
from dataclasses import dataclass
from typing import List, Dict, Optional

@dataclass
class EndpointSearchDocument:
    """Comprehensive search document for API endpoint"""

    # Core identification
    endpoint_id: str
    endpoint_path: str
    http_method: str

    # Searchable content
    operation_summary: str
    operation_description: str
    path_segments: List[str]

    # Parameters
    parameter_names: List[str]
    parameter_descriptions: str
    parameter_types: List[str]
    required_parameters: List[str]

    # Response information
    response_types: List[str]
    response_schemas: List[str]
    status_codes: List[int]

    # Security and metadata
    security_requirements: List[str]
    security_scopes: List[str]
    tags: List[str]
    deprecated: bool

    # Composite search fields
    searchable_text: str  # Combined text for full-text search
    keywords: List[str]   # Extracted keywords for enhanced matching
```

### Document Creation Pipeline
```python
class EndpointDocumentProcessor:
    """Processes normalized endpoint data into comprehensive search documents"""

    async def create_endpoint_document(self, endpoint_data: Dict) -> EndpointSearchDocument:
        """Create comprehensive search document from endpoint data"""

        # Extract path information
        path_segments = self.extract_path_segments(endpoint_data["path"])
        path_parameters = self.extract_path_parameters(endpoint_data["path"])

        # Process parameters
        parameter_info = self.process_parameters(endpoint_data["parameters"])

        # Extract response information
        response_info = self.extract_response_info(endpoint_data["responses"])

        # Process security requirements
        security_info = self.extract_security_info(endpoint_data["security"])

        # Create composite searchable text
        searchable_text = self.create_composite_text(
            endpoint_data, parameter_info, response_info
        )

        return EndpointSearchDocument(
            endpoint_id=endpoint_data["id"],
            endpoint_path=endpoint_data["path"],
            http_method=endpoint_data["method"],
            operation_summary=endpoint_data["summary"],
            operation_description=endpoint_data["description"],
            path_segments=path_segments,
            parameter_names=parameter_info["names"],
            parameter_descriptions=parameter_info["descriptions"],
            parameter_types=parameter_info["types"],
            required_parameters=parameter_info["required"],
            response_types=response_info["content_types"],
            response_schemas=response_info["schema_names"],
            status_codes=response_info["status_codes"],
            security_requirements=security_info["schemes"],
            security_scopes=security_info["scopes"],
            tags=endpoint_data["tags"],
            deprecated=endpoint_data.get("deprecated", False),
            searchable_text=searchable_text,
            keywords=self.extract_keywords(searchable_text)
        )
```

### Path Processing Algorithm
```python
def extract_path_segments(self, path: str) -> List[str]:
    """Extract searchable path segments"""
    # Remove path parameters: /users/{id}/posts → /users/posts
    clean_path = re.sub(r'\{[^}]+\}', '', path)
    # Split and filter segments
    segments = [seg for seg in clean_path.split('/') if seg and seg != 'api']
    return segments

def extract_path_parameters(self, path: str) -> List[str]:
    """Extract path parameter names"""
    return re.findall(r'\{([^}]+)\}', path)
```

### Composite Text Generation
```python
def create_composite_text(self, endpoint_data: Dict,
                         parameter_info: Dict, response_info: Dict) -> str:
    """Create comprehensive searchable text combining all endpoint aspects"""

    text_components = [
        endpoint_data.get("summary", ""),
        endpoint_data.get("description", ""),
        " ".join(parameter_info["descriptions"]),
        " ".join(response_info["descriptions"]),
        " ".join(endpoint_data.get("tags", []))
    ]

    return " ".join(filter(None, text_components))
```

### Search Document Optimization
- **Text Normalization**: Lowercase, stem, remove stop words for better matching
- **Keyword Extraction**: Extract technical terms, resource names, operation verbs
- **Content Deduplication**: Avoid repeating information across document fields
- **Relevance Boosting**: Emphasize important terms in summaries and resource names

## Definition of Done
- [x] Comprehensive endpoint path indexing with parameter extraction and normalization
- [x] Operation descriptions, summaries, and tags indexed with full-text capabilities
- [x] All parameter types indexed with names, descriptions, types, and constraints
- [x] Response schema information included in endpoint search documents
- [x] Security requirements extracted and indexed for authentication-based discovery
- [x] Composite search documents capture complete endpoint semantic context
- [x] Path segment extraction supports hierarchical and REST pattern search
- [x] Document creation handles edge cases and missing information gracefully
- [x] Search document structure optimized for BM25 relevance ranking
- [x] Indexing performance supports large-scale API documentation (1000+ endpoints)
- [x] Content extraction accuracy verified at 100% against sample APIs
- [x] Comprehensive unit tests for document creation and content extraction (≥80% coverage)
- [x] Integration tests with sample Ozon API validate real-world endpoint complexity
- [x] Performance testing validates document creation speed and memory efficiency
- [x] Search document quality testing with relevance ranking validation
- [x] Documentation updated with endpoint indexing architecture and optimization

## Dev Agent Record

### Agent Model Used
Claude Code with Dev Agent (James) persona - Story 3.2 implementation

### Debug Log References
- Unit tests: `src/tests/unit/test_search/test_endpoint_indexing.py`
- Integration tests: `src/tests/integration/test_endpoint_indexing_integration.py`
- Performance validation: Batch processing of 100 endpoints in 0.0024s (target: <10ms per endpoint)
- Memory efficiency: 0.0059 MB per endpoint processed

### Completion Notes
✅ **Core Implementation**:
- `EndpointSearchDocument` dataclass with 30+ comprehensive fields
- `EndpointDocumentProcessor` with intelligent path, parameter, response, and security processing
- Enhanced Whoosh index schema with optimized field weights and analyzers

✅ **Advanced Features**:
- Automatic path parameter extraction from URL patterns (`{param}` and `:param`)
- Operation type classification (create, read, update, delete, list, search)
- Security scheme type detection and scope processing
- Composite text generation for optimized search relevance
- Keyword extraction with stop word filtering

✅ **Quality Validation**:
- 22/22 unit tests passing with 91% code coverage on new modules
- 5/5 integration tests passing with realistic API data
- Performance: <0.01s per endpoint (target met)
- Memory: <0.01 MB per endpoint (efficient)
- Edge case handling for malformed and incomplete data

✅ **Integration**:
- Updated `SearchIndexManager` to use new comprehensive document processor
- Enhanced index schema with 25+ searchable fields
- Conversion utilities for seamless Whoosh integration

### File List
**New Files Created:**
- `src/swagger_mcp_server/search/endpoint_indexing.py` - Core implementation
- `src/tests/unit/test_search/test_endpoint_indexing.py` - Unit tests
- `src/tests/integration/test_endpoint_indexing_integration.py` - Integration tests

**Modified Files:**
- `src/swagger_mcp_server/search/index_schema.py` - Enhanced schema with new fields
- `src/swagger_mcp_server/search/index_manager.py` - Updated to use new processor

### Change Log
1. **Phase 1**: Implemented `EndpointSearchDocument` dataclass with comprehensive field structure
2. **Phase 2**: Built `EndpointDocumentProcessor` with intelligent extraction algorithms
3. **Phase 3**: Enhanced Whoosh index schema with optimized field weights and analyzers
4. **Phase 4**: Updated `SearchIndexManager` integration for seamless document processing
5. **Phase 5**: Created comprehensive test suite with unit and integration coverage
6. **Phase 6**: Performance validation and optimization for large-scale processing

### Status
**Ready for Review** - All acceptance criteria met, comprehensive testing completed, performance validated

## Validation Criteria
- All endpoint aspects (path, parameters, responses, security) indexed comprehensively
- Search documents enable multi-dimensional endpoint discovery and ranking
- Path processing handles all common OpenAPI path parameter patterns
- Parameter extraction captures complete parameter context and metadata
- Response information integration provides complete endpoint understanding
- Document quality produces relevant search results for test queries

## Risk Assessment
**High Risk** - Content extraction complexity and search document optimization

**Primary Risks:**
- Complex OpenAPI specification variations affecting content extraction accuracy
- Search document size growth impacting indexing and search performance
- Parameter relationship extraction complexity for conditional requirements
- Response schema integration affecting document creation performance

**Mitigation Strategies:**
- Incremental development with simple endpoints first, adding complexity progressively
- Document size monitoring and optimization throughout development
- Comprehensive testing with diverse OpenAPI specifications
- Performance benchmarking for document creation and indexing impact
- Fallback mechanisms for complex parameter and response scenarios

**Rollback Plan:**
- Simplify endpoint documents to basic path and description indexing
- Remove complex parameter relationship processing if performance issues
- Fall back to simpler document structure with reduced search capabilities
- Maintain basic search functionality while addressing complex indexing issues

## Story Estimation
**Complexity**: High
**Effort**: 4-5 development sessions (16-20 hours)
**Risk Level**: High
**Dependencies**: 3 (Stories 3.1, 1.3, 1.4)