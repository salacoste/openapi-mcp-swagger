# Story 10.1: Current State Investigation and Documentation

## Status
Ready for Development

## Story

**As a** QA engineer,
**I want** complete understanding of current searchEndpoints category filtering behavior,
**so that** we can validate improvements after Issues #002 and #003 are resolved.

## Story Context

**Existing System Integration:**

- Integrates with: `swagger_mcp_server/server/mcp_server_v2.py`, `swagger_mcp_server/storage/repository.py`
- Technology: Python 3.11+, SQLite, FTS5 search
- Follows pattern: Code review, SQL query analysis, behavior documentation
- Touch points:
  - searchEndpoints implementation
  - EndpointRepository query methods
  - Database schema and indexes
  - Production logs analysis

## Acceptance Criteria

**Functional Requirements:**

1. searchEndpoints implementation fully documented:
   - SQL queries identified and documented
   - Filtering logic explained (AND vs OR)
   - Data source identified (table vs tags)
   - Fallback behavior documented

2. Current behavior baseline established:
   - Test query + category combinations
   - Document actual results vs expected
   - Identify cross-category contamination
   - Measure performance metrics

3. Database schema analysis complete:
   - Verify endpoints-categories relationship
   - Check indexes and constraints
   - Validate foreign keys
   - Document schema structure

4. Root cause analysis documented:
   - Why mixed results occur
   - What data source is used
   - How filters are combined
   - What needs to change after Issue #002

**Quality Requirements:**

5. Documentation comprehensive and clear
6. Baseline results reproducible
7. SQL queries tested and verified
8. Performance metrics recorded

## Tasks / Subtasks

- [ ] **Task 1: Code Review of searchEndpoints**
  - [ ] Read searchEndpoints method in mcp_server_v2.py
  - [ ] Identify SQL queries or search logic
  - [ ] Document filtering parameters
  - [ ] Check for category parameter usage
  - [ ] Identify AND vs OR logic

- [ ] **Task 2: Repository Method Analysis**
  - [ ] Review EndpointRepository.search() method
  - [ ] Document SQL WHERE clauses
  - [ ] Check FTS5 usage
  - [ ] Identify category filtering logic
  - [ ] Document fallback mechanisms

- [ ] **Task 3: Database Schema Analysis**
  - [ ] Query sqlite_master for schema
  - [ ] Check endpoints table structure
  - [ ] Verify category relationship
  - [ ] Check indexes (category, category_id)
  - [ ] Test foreign key constraints

- [ ] **Task 4: Behavior Testing and Documentation**
  - [ ] Test: query="campaign", category="statistics"
  - [ ] Test: query="list", category="campaign"
  - [ ] Test: query="", category="statistics" (category only)
  - [ ] Test: query="campaign", category=null (query only)
  - [ ] Document all results with analysis

- [ ] **Task 5: Root Cause Documentation**
  - [ ] Explain why mixed results occur
  - [ ] Document current data source
  - [ ] Analyze AND vs OR logic
  - [ ] Create improvement recommendations

- [ ] **Task 6: Performance Baseline**
  - [ ] Measure query response times
  - [ ] Test with different result sizes
  - [ ] Document performance metrics
  - [ ] Identify performance bottlenecks

- [ ] **Task 7: Create Investigation Report**
  - [ ] Compile all findings
  - [ ] Include code snippets
  - [ ] Add SQL query examples
  - [ ] Document expected vs actual behavior
  - [ ] Create baseline for comparison

## Implementation Details

### Investigation Checklist

```markdown
## searchEndpoints Investigation Report

### Current Implementation

**File:** src/swagger_mcp_server/server/mcp_server_v2.py

**Method Signature:**
```python
async def searchEndpoints(
    query: str,
    method: Optional[str] = None,
    category: Optional[str] = None,
    limit: int = 10
)
```

**SQL Query:** [Document actual query found]

**Filtering Logic:** [Document AND vs OR logic]

**Data Source:** [endpoint_categories table | tags | path matching]

### Test Results

| Query | Category | Expected | Actual | Issue |
|-------|----------|----------|--------|-------|
| "campaign" | "statistics" | Only statistics | Mixed | Cross-category |
| "list" | "campaign" | Only campaign | Mixed | Cross-category |
| "" | "statistics" | All statistics | ? | To test |

### Root Cause

[Document why mixed results occur]

### Recommendations

[Document what needs to change]
```

## Dependencies

**Depends On:**
- None - pure investigation

**Blocks:**
- Story 10.2 - Test development needs baseline

## Definition of Done

- [x] searchEndpoints code fully reviewed
- [x] Current behavior documented
- [x] Database schema analyzed
- [x] Root cause identified
- [x] Baseline established
- [x] Performance metrics recorded
- [x] Investigation report complete
- [x] Ready for Story 10.2

## Related Files

**Created:**
- `docs/qa/investigation/searchEndpoints-behavior-baseline.md`
- `docs/qa/investigation/category-filtering-analysis.md`

**Reviewed:**
- `src/swagger_mcp_server/server/mcp_server_v2.py`
- `src/swagger_mcp_server/storage/repository.py`

## References

- Epic: `docs/stories/epic-10-category-filtering-validation.md`
- Issue: `docs/dev-comments/issue-004-category-filtering-validation.md`
