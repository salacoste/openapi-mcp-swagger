# Story 7.1: Pydantic Model Enhancement with Union Type Support

## Status
Ready for Development

## Story

**As a** MCP client user,
**I want** the getExample method to accept integer endpoint IDs without validation errors,
**so that** I can use the endpoint IDs displayed in searchEndpoints results directly without manual type conversion.

## Story Context

**Existing System Integration:**

- Integrates with: `swagger_mcp_server/server/mcp_server_v2.py` (MCP tool definitions)
- Technology: Python 3.11+, Pydantic 2.x, FastMCP framework, MCP SDK 1.0+
- Follows pattern: Pydantic BaseModel validation, FastMCP @mcp.tool() decorator, type coercion
- Touch points:
  - `server/mcp_server_v2.py`: `getExampleArguments` Pydantic model
  - `server/mcp_server_v2.py`: `getExample()` MCP tool method
  - MCP tool schema generation (automatic via FastMCP)
  - Generated servers: `generated-mcp-servers/*/server.py`

**Problem Context:**

Currently, searchEndpoints displays endpoint IDs as integers (e.g., "Endpoint ID: 1"), but getExample only accepts strings, causing Pydantic validation errors:

```
Error: 1 validation error for getExampleArguments
endpoint_id
  Input should be a valid string [type=string_type, input_value=1, input_type=int]
```

This creates unnecessary friction and breaks the natural user workflow.

## Acceptance Criteria

**Functional Requirements:**

1. Pydantic model `getExampleArguments` accepts `Union[str, int]` for endpoint_id:
   - Integer endpoint IDs: `1`, `2`, `10` ✅
   - String endpoint IDs: `"1"`, `"2"`, `"10"` ✅
   - Path-based IDs: `"/api/client/campaign"` ✅

2. Automatic type coercion implemented via Pydantic validator:
   - Converts integer inputs to strings internally
   - Preserves string inputs unchanged
   - Maintains backward compatibility with path-based strings

3. MCP tool schema updated to reflect Union type:
   - inputSchema accepts both string and integer types
   - Documentation clarifies accepted formats
   - No breaking changes to existing behavior

**Integration Requirements:**

4. Existing getExample method logic remains unchanged
5. No changes to method signature or return type
6. Generated MCP servers automatically inherit the fix
7. FastMCP decorator continues to work correctly

**Quality Requirements:**

8. All three input formats produce identical results:
   - `getExample(1, "python")` == `getExample("1", "python")` == `getExample("/api/client/campaign", "python")`

9. Error handling for invalid types:
   - Float values: clear error message
   - None values: clear error message
   - Other types: clear error message

10. Performance impact negligible (< 1ms overhead for type coercion)

## Tasks / Subtasks

- [ ] **Task 1: Update Pydantic Model with Union Type** (AC: 1, 2, 3)
  - [ ] Import Union from typing module
  - [ ] Change `endpoint_id: str` to `endpoint_id: Union[str, int]`
  - [ ] Add Pydantic validator decorator for type coercion
  - [ ] Implement validator to convert int → str
  - [ ] Preserve existing string handling (paths, string IDs)
  - [ ] Verify MCP schema generation works correctly

- [ ] **Task 2: Update Method Documentation** (AC: 3)
  - [ ] Update docstring to document all accepted formats
  - [ ] Add examples for integer, string, and path inputs
  - [ ] Clarify automatic type conversion behavior
  - [ ] Update inline comments if needed

- [ ] **Task 3: Unit Testing for Type Coercion** (AC: 8, 9)
  - [ ] Create test file: `test_getexample_validation.py`
  - [ ] Test integer endpoint_id validation (input: 1)
  - [ ] Test string endpoint_id validation (input: "1")
  - [ ] Test path endpoint_id validation (input: "/api/client/campaign")
  - [ ] Test result equivalence across all three formats
  - [ ] Test error handling for invalid types (float, None)
  - [ ] Test edge cases (0, negative numbers, empty string)

- [ ] **Task 4: Verify Backward Compatibility** (AC: 4, 5, 6)
  - [ ] Test existing string inputs still work
  - [ ] Test existing path-based inputs still work
  - [ ] Verify method logic unchanged
  - [ ] Verify MCP tool registration still works
  - [ ] Test with FastMCP decorator

- [ ] **Task 5: Performance Validation** (AC: 10)
  - [ ] Benchmark type coercion overhead
  - [ ] Ensure < 1ms per call
  - [ ] Compare with baseline performance
  - [ ] Document performance metrics

## Implementation Details

### Current Implementation (Before)

```python
from pydantic import BaseModel

class getExampleArguments(BaseModel):
    endpoint_id: str  # ❌ Only accepts strings
    language: str = "curl"

@mcp.tool()
async def getExample(endpoint_id: str, language: str = "curl"):
    """Generate code examples for API endpoints.

    Args:
        endpoint_id: Endpoint ID (integer) or path
        language: Programming language for the example
    """
    # ... implementation
```

### Target Implementation (After)

```python
from typing import Union
from pydantic import BaseModel, validator

class getExampleArguments(BaseModel):
    endpoint_id: Union[str, int]  # ✅ Accept both types
    language: str = "curl"

    @validator('endpoint_id')
    def convert_endpoint_id_to_string(cls, v):
        """Convert endpoint_id to string for consistent processing."""
        return str(v)

@mcp.tool()
async def getExample(endpoint_id: str, language: str = "curl"):
    """Generate code examples for API endpoints.

    Args:
        endpoint_id: Endpoint ID as integer (1), string ("1"), or path ("/api/client/campaign")
        language: Programming language for the example (curl, javascript, python, typescript)

    Examples:
        getExample(1, "python")  # Integer ID
        getExample("1", "python")  # String ID
        getExample("/api/client/campaign", "curl")  # Path-based ID
    """
    # ... implementation (unchanged)
```

## Test Coverage

### Test Matrix

| Input Type | Example Value | Expected Behavior | Test Case |
|------------|---------------|-------------------|-----------|
| Integer | `1` | ✅ Success, converted to "1" | `test_integer_endpoint_id` |
| String | `"1"` | ✅ Success, unchanged | `test_string_endpoint_id` |
| Path | `"/api/client/campaign"` | ✅ Success, unchanged | `test_path_endpoint_id` |
| Float | `1.5` | ❌ Validation error | `test_invalid_float` |
| None | `None` | ❌ Validation error | `test_invalid_none` |
| Result equivalence | `getExample(1) == getExample("1")` | ✅ Identical output | `test_result_equivalence` |

### Example Test Cases

```python
import pytest
from swagger_mcp_server.server.mcp_server_v2 import getExampleArguments

def test_integer_endpoint_id():
    """Test integer endpoint_id is accepted and converted"""
    args = getExampleArguments(endpoint_id=1, language="python")
    assert args.endpoint_id == "1"
    assert isinstance(args.endpoint_id, str)

def test_string_endpoint_id():
    """Test string endpoint_id is accepted unchanged"""
    args = getExampleArguments(endpoint_id="1", language="python")
    assert args.endpoint_id == "1"
    assert isinstance(args.endpoint_id, str)

def test_path_endpoint_id():
    """Test path-based endpoint_id is accepted unchanged"""
    args = getExampleArguments(endpoint_id="/api/client/campaign", language="python")
    assert args.endpoint_id == "/api/client/campaign"

def test_result_equivalence():
    """Test all input formats produce identical results"""
    result_int = await getExample(endpoint_id=1, language="curl")
    result_str = await getExample(endpoint_id="1", language="curl")
    assert result_int == result_str

def test_invalid_float():
    """Test float endpoint_id raises validation error"""
    with pytest.raises(ValidationError):
        getExampleArguments(endpoint_id=1.5, language="python")

def test_invalid_none():
    """Test None endpoint_id raises validation error"""
    with pytest.raises(ValidationError):
        getExampleArguments(endpoint_id=None, language="python")
```

## Dependencies

**Blocks:**
- Story 7.2 (Comprehensive Test Coverage) - needs Pydantic model update first
- Story 7.3 (Integration Testing) - needs model and tests complete

**Depends On:**
- None - independent story

## Risks and Mitigation

**Risk 1: Pydantic validator might introduce unexpected side effects**
- Mitigation: Comprehensive unit tests, explicit validator logic, test all input types

**Risk 2: MCP schema generation might not handle Union types correctly**
- Mitigation: Verify FastMCP schema generation, test with MCP clients, fallback to explicit schema if needed

**Risk 3: Performance overhead from validator**
- Mitigation: Benchmark performance, ensure < 1ms overhead, optimize if needed

## Definition of Done

- [x] Pydantic model accepts Union[str, int] for endpoint_id
- [x] Validator converts integers to strings automatically
- [x] MCP tool schema reflects Union type
- [x] Docstring updated with examples for all input formats
- [x] Unit tests cover all input types and edge cases
- [x] All tests pass (existing + new)
- [x] Backward compatibility verified
- [x] Performance benchmarks meet targets (< 1ms overhead)
- [x] Code reviewed and approved
- [x] Ready for Story 7.2 integration

## Related Files

**Modified:**
- `src/swagger_mcp_server/server/mcp_server_v2.py` - Pydantic model and getExample method

**New:**
- `src/tests/unit/test_server/test_getexample_validation.py` - Validation unit tests

**Generated (Auto-Updated):**
- `generated-mcp-servers/*/server.py` - Generated servers inherit fix

## References

- Issue source: `docs/dev-comments/issue-001-getexample-validation.md`
- Epic: `docs/stories/epic-7-getexample-validation-fix.md`
- Pydantic validators: https://docs.pydantic.dev/latest/concepts/validators/
- FastMCP documentation: https://github.com/jlowin/fastmcp
