# Story 10.2: Comprehensive Test Suite Development

## Status
Ready for Development

## Story

**As a** QA engineer,
**I want** comprehensive test suite for category filtering scenarios,
**so that** we verify exact category matching after Issues #002 and #003 are resolved.

## Story Context

**Existing System Integration:**

- Integrates with: searchEndpoints method, test database fixtures
- Technology: Python 3.11+, pytest, test fixtures
- Follows pattern: Existing test patterns in tests/unit/test_server/
- Touch points:
  - Story 10.1 complete (baseline established)
  - searchEndpoints method
  - Test database with known categories

## Acceptance Criteria

**Functional Requirements:**

1. Test exact category matching:
   - category="statistics" → only statistics endpoints
   - No cross-category contamination

2. Test category + query combination:
   - Both filters apply with AND logic
   - query AND category, not query OR category

3. Test edge cases:
   - Invalid category returns empty
   - Null category returns all results
   - Empty query with category works

4. Test all filter combinations:
   - query + category + method (3-way AND)
   - query + category
   - query + method
   - category + method
   - Each filter alone

**Quality Requirements:**

5. Test coverage ≥ 95% for category filtering
6. All tests documented with expected behavior
7. Before/after comparison tests
8. Performance benchmarks included

## Tasks / Subtasks

- [ ] **Task 1: Create Test File**
  - [ ] Create test_unit/test_server/test_search_category_filter.py
  - [ ] Set up test database with clear categories
  - [ ] Create test fixtures
  - [ ] Import necessary utilities

- [ ] **Task 2: Exact Category Matching Tests**
  - [ ] Test category="statistics" → only statistics
  - [ ] Test category="campaign" → only campaign
  - [ ] Verify no cross-category results
  - [ ] Test all 6 Ozon categories

- [ ] **Task 3: Category + Query Tests**
  - [ ] Test query="campaign" + category="statistics"
  - [ ] Test query="list" + category="campaign"
  - [ ] Verify AND logic (not OR)
  - [ ] Test empty results scenario

- [ ] **Task 4: Edge Case Tests**
  - [ ] Test invalid category
  - [ ] Test null category
  - [ ] Test empty query with category
  - [ ] Test special characters

- [ ] **Task 5: Multi-Filter Tests**
  - [ ] Test query + category + method
  - [ ] Test all 2-filter combinations
  - [ ] Test single filters
  - [ ] Verify AND logic throughout

- [ ] **Task 6: Before/After Comparison**
  - [ ] Create comparison test framework
  - [ ] Document current behavior
  - [ ] Define expected behavior
  - [ ] Create assertion helpers

- [ ] **Task 7: Performance Tests**
  - [ ] Benchmark category filtering
  - [ ] Test with large result sets
  - [ ] Measure query times
  - [ ] Compare with baseline

## Implementation Details

### Test Structure

```python
import pytest
from swagger_mcp_server.server.mcp_server_v2 import searchEndpoints

@pytest.mark.asyncio
class TestSearchEndpointsCategoryFilter:
    """Comprehensive tests for category filtering"""

    async def test_exact_category_match_statistics(self, test_db):
        """Test category filter returns only statistics endpoints"""
        results = await searchEndpoints(
            query="",
            category="statistics",
            limit=50
        )

        # Verify all results are statistics category
        assert len(results) > 0
        assert all(r["category"] == "statistics" for r in results)

    async def test_category_excludes_other_categories(self, test_db):
        """Test category filter excludes other categories"""
        results = await searchEndpoints(
            query="",
            category="campaign",
            limit=50
        )

        # Verify no statistics endpoints
        paths = [r["path"] for r in results]
        assert not any("/statistics" in path for path in paths)

    async def test_query_and_category_both_apply(self, test_db):
        """Test query AND category filter (not OR)"""
        results = await searchEndpoints(
            query="campaign",
            category="statistics",
            limit=50
        )

        # Results must:
        # 1. Be in "statistics" category
        # 2. Match "campaign" in path/description
        for result in results:
            assert result["category"] == "statistics"
            assert "campaign" in result["path"].lower() or \
                   "campaign" in result.get("description", "").lower()

    async def test_invalid_category_returns_empty(self, test_db):
        """Test invalid category returns empty results"""
        results = await searchEndpoints(
            query="test",
            category="nonexistent",
            limit=50
        )

        assert len(results) == 0

    async def test_null_category_returns_all(self, test_db):
        """Test null category returns all matching results"""
        with_category = await searchEndpoints(
            query="campaign",
            category="statistics"
        )

        without_category = await searchEndpoints(
            query="campaign",
            category=None
        )

        assert len(without_category) >= len(with_category)
```

## Test Coverage Matrix

| Test | Query | Category | Method | Expected Result | AC |
|------|-------|----------|--------|-----------------|-----|
| Exact match | "" | "statistics" | null | Only statistics | 1 |
| Exclude others | "" | "campaign" | null | No statistics | 1 |
| AND logic | "campaign" | "statistics" | null | Statistics with "campaign" | 2 |
| Invalid | "test" | "invalid" | null | Empty | 3 |
| Null category | "campaign" | null | null | All with "campaign" | 3 |
| 3-way AND | "list" | "campaign" | "GET" | Campaign GET with "list" | 4 |

## Dependencies

**Depends On:**
- Story 10.1 - Baseline documentation

**Blocks:**
- Story 10.3 - Post-fix validation

## Definition of Done

- [x] Test file created with 20+ tests
- [x] Exact category matching tests pass
- [x] Category + query tests pass
- [x] Edge case tests pass
- [x] Multi-filter tests pass
- [x] Test coverage ≥ 95%
- [x] Performance benchmarks recorded
- [x] Ready for Story 10.3

## Related Files

**New:**
- `src/tests/unit/test_server/test_search_category_filter.py`
- `src/tests/performance/test_search_category_performance.py`

## References

- Epic: `docs/stories/epic-10-category-filtering-validation.md`
- Story 10.1: `docs/stories/10.1.current-state-investigation-documentation.md`
