# Story 9.1: Add @mcp.tool() Decorator and Validate Registration

## Status
**BLOCKED - Needs Investigation and Rewrite**

**Reason:** Story based on false assumptions about codebase architecture
**Blocked By:** Epic 9 investigation checklist must be completed first
**Action Required:** Product Owner/Analyst to complete investigation, then rewrite story based on findings
**Previous Status:** ~~Ready for Development~~ (invalidated by technical review)

## Story

**As a** MCP server developer,
**I want** getEndpointCategories method registered with @mcp.tool() decorator,
**so that** the method appears in the MCP tools list and becomes accessible to MCP clients.

## Story Context

**Existing System Integration:**

- Integrates with: `swagger_mcp_server/server/mcp_server_v2.py` (MCP tool registration)
- Technology: Python 3.11+, FastMCP framework, @mcp.tool() decorator
- Follows pattern: Existing tool registration (searchEndpoints, getSchema, getExample)
- Touch points:
  - `server/mcp_server_v2.py`: getEndpointCategories method implementation
  - FastMCP tool registration system
  - MCP tools/list protocol method
  - MCP schema auto-generation

**Problem Context:**

The getEndpointCategories method is implemented but not registered as an MCP tool. Server initialization shows only 3 tools instead of 4:

```json
{
  "tools": [
    {"name": "searchEndpoints"},
    {"name": "getSchema"},
    {"name": "getExample"}
    // ❌ getEndpointCategories MISSING
  ]
}
```

## Acceptance Criteria

**Functional Requirements:**

1. @mcp.tool() decorator added to getEndpointCategories:
   - Decorator applied following FastMCP conventions
   - Method signature matches other tools
   - Type hints present for schema generation
   - Docstring format matches other tools

2. Method appears in tools/list response:
   - Server initialization lists 4 tools (not 3)
   - getEndpointCategories appears in tools array
   - MCP schema generated correctly
   - inputSchema has correct structure

3. Method signature and docstring validated:
   - Parameters: include_counts (bool), include_methods (bool)
   - Return type: list[dict]
   - Docstring: One-line summary, Args section, Returns section
   - Examples in docstring

4. MCP schema validation:
   - inputSchema type is "object"
   - Properties include include_counts and include_methods
   - Default values preserved (both true)
   - Type annotations correct (boolean)

**Integration Requirements:**

5. Existing tool registrations unchanged
6. FastMCP continues to work correctly
7. Server starts without errors
8. No breaking changes to MCP protocol

**Quality Requirements:**

9. Unit test verifies tool registration
10. Unit test verifies MCP schema structure
11. Integration test verifies method callable via MCP
12. All existing tests pass

## Tasks / Subtasks

- [ ] **Task 1: Locate getEndpointCategories Method** (AC: 1)
  - [ ] Search for `def getEndpointCategories` in mcp_server_v2.py
  - [ ] Verify method implementation exists
  - [ ] Review current signature and docstring
  - [ ] Identify any issues with current implementation

- [ ] **Task 2: Add @mcp.tool() Decorator** (AC: 1)
  - [ ] Add `@mcp.tool()` decorator above method definition
  - [ ] Verify decorator is at same indentation as other tools
  - [ ] Ensure no extra arguments needed in decorator
  - [ ] Check FastMCP import is present at top of file

- [ ] **Task 3: Validate Method Signature** (AC: 1, 3)
  - [ ] Verify type hints: `include_counts: bool = True`
  - [ ] Verify type hints: `include_methods: bool = True`
  - [ ] Verify return type: `-> list[dict]` or `-> List[Dict]`
  - [ ] Ensure async function: `async def getEndpointCategories`
  - [ ] Match signature pattern of other tools

- [ ] **Task 4: Update/Validate Docstring** (AC: 1, 3)
  - [ ] One-line summary at top
  - [ ] Blank line after summary
  - [ ] Args section with parameter descriptions
  - [ ] Returns section with return value description
  - [ ] Optional Examples section
  - [ ] Follow existing docstring format

- [ ] **Task 5: Test Server Initialization** (AC: 2, 7)
  - [ ] Start MCP server locally
  - [ ] Check server logs for errors
  - [ ] Verify server starts successfully
  - [ ] Check tools registration in logs

- [ ] **Task 6: Test tools/list Response** (AC: 2)
  - [ ] Call tools/list via MCP protocol
  - [ ] Verify 4 tools returned (not 3)
  - [ ] Verify getEndpointCategories in list
  - [ ] Check tool name is correct
  - [ ] Verify description is present

- [ ] **Task 7: Validate MCP Schema** (AC: 4)
  - [ ] Check inputSchema structure
  - [ ] Verify properties object exists
  - [ ] Verify include_counts property
  - [ ] Verify include_methods property
  - [ ] Check default values
  - [ ] Check type annotations

- [ ] **Task 8: Unit Tests** (AC: 9, 10)
  - [ ] Create `test_unit/test_server/test_mcp_tool_registration.py`
  - [ ] Test getEndpointCategories in tools list
  - [ ] Test tool count is 4
  - [ ] Test tool schema structure
  - [ ] Test inputSchema properties

- [ ] **Task 9: Integration Test** (AC: 11)
  - [ ] Test calling getEndpointCategories via MCP
  - [ ] Verify no protocol errors
  - [ ] Verify method executes
  - [ ] Verify response format

- [ ] **Task 10: Regression Testing** (AC: 12)
  - [ ] Run full existing test suite
  - [ ] Verify all tests pass
  - [ ] Check existing tools still work
  - [ ] Verify no breaking changes

## Implementation Details

### Current State (Before)

```python
# ❌ Missing @mcp.tool() decorator
async def getEndpointCategories(
    include_counts: bool = True,
    include_methods: bool = True
) -> list[dict]:
    """Get list of endpoint categories."""
    # ... implementation
```

### Target State (After)

```python
@mcp.tool()  # ✅ Add decorator
async def getEndpointCategories(
    include_counts: bool = True,
    include_methods: bool = True
) -> list[dict]:
    """
    Get list of all endpoint categories with metadata.

    Args:
        include_counts: Include endpoint count per category
        include_methods: Include HTTP methods per category

    Returns:
        List of category objects with name, display_name, count, methods

    Examples:
        # Get all categories with counts and methods
        categories = await getEndpointCategories()

        # Get only category names (no counts or methods)
        categories = await getEndpointCategories(
            include_counts=False,
            include_methods=False
        )
    """
    try:
        db_manager = get_database_manager()
        categories = db_manager.get_endpoint_categories()

        result = []
        for category in categories:
            cat_dict = {
                "name": category.category_name,
                "display_name": category.display_name or category.category_name,
                "description": category.description or ""
            }

            if include_counts:
                cat_dict["count"] = category.endpoint_count or 0

            if include_methods:
                cat_dict["methods"] = json.loads(category.http_methods) if category.http_methods else []

            result.append(cat_dict)

        return result

    except Exception as e:
        logger.error(f"Error retrieving endpoint categories: {e}")
        return []
```

### Expected MCP Schema

```json
{
  "name": "getEndpointCategories",
  "description": "Get list of all endpoint categories with metadata.\n\nArgs:\n    include_counts: Include endpoint count per category\n    include_methods: Include HTTP methods per category\n\nReturns:\n    List of category objects with name, display_name, count, methods",
  "inputSchema": {
    "type": "object",
    "properties": {
      "include_counts": {
        "type": "boolean",
        "default": true,
        "title": "Include Counts",
        "description": "Include endpoint count per category"
      },
      "include_methods": {
        "type": "boolean",
        "default": true,
        "title": "Include Methods",
        "description": "Include HTTP methods per category"
      }
    },
    "title": "getEndpointCategoriesArguments"
  }
}
```

### Test Examples

```python
def test_get_endpoint_categories_registered():
    """Verify getEndpointCategories is registered as MCP tool"""
    from swagger_mcp_server.server.mcp_server_v2 import mcp

    tools = mcp.list_tools()
    tool_names = [t["name"] for t in tools]

    assert "getEndpointCategories" in tool_names
    assert len(tool_names) == 4  # searchEndpoints, getSchema, getExample, getEndpointCategories

def test_get_endpoint_categories_schema():
    """Verify getEndpointCategories has correct MCP schema"""
    from swagger_mcp_server.server.mcp_server_v2 import mcp

    tools = mcp.list_tools()
    get_cats = next(t for t in tools if t["name"] == "getEndpointCategories")

    assert "description" in get_cats
    assert "inputSchema" in get_cats
    assert get_cats["inputSchema"]["type"] == "object"

    properties = get_cats["inputSchema"]["properties"]
    assert "include_counts" in properties
    assert "include_methods" in properties
    assert properties["include_counts"]["type"] == "boolean"
    assert properties["include_counts"]["default"] is True
```

## Test Coverage Matrix

| Test Case | Expected Result | AC |
|-----------|-----------------|-----|
| Tool registration | getEndpointCategories in tools list | 2, 9 |
| Tool count | 4 tools total | 2, 9 |
| Schema structure | Valid inputSchema | 4, 10 |
| Schema properties | include_counts and include_methods present | 4, 10 |
| MCP callable | Method executes via MCP | 11 |
| Existing tools | searchEndpoints/getSchema/getExample work | 5, 12 |

## Dependencies

**Blocks:**
- Story 9.2 (Server Regeneration) - needs decorator added first
- Story 9.3 (End-to-End Testing) - needs registration working

**Depends On:**
- None - independent fix

## Risks and Mitigation

**Risk 1: Decorator might break server initialization**
- Mitigation: Test server startup, follow exact pattern of existing tools, code review

**Risk 2: MCP schema might not generate correctly**
- Mitigation: Verify type hints, test FastMCP behavior, validate schema manually

**Risk 3: Method might have implementation issues only revealed after registration**
- Mitigation: Review implementation, test with empty database (Issue #002 dependency), error handling

## Definition of Done

- [x] @mcp.tool() decorator added to getEndpointCategories
- [x] Method signature validated with type hints
- [x] Docstring updated to match tool format
- [x] Server starts successfully
- [x] getEndpointCategories appears in tools/list (4 tools total)
- [x] MCP schema correct and complete
- [x] Unit tests pass (registration and schema)
- [x] Integration test passes (method callable)
- [x] All existing tests pass
- [x] Code reviewed and approved
- [x] Ready for Story 9.2 server regeneration

## Related Files

**Modified:**
- `src/swagger_mcp_server/server/mcp_server_v2.py` - Add @mcp.tool() decorator

**New:**
- `src/tests/unit/test_server/test_mcp_tool_registration.py` - Registration tests

**Updated:**
- `src/tests/unit/test_server/test_mcp_get_endpoint_categories.py` - Add registration verification

## References

- Epic: `docs/stories/epic-9-getendpointcategories-registration-fix.md`
- Issue source: `docs/dev-comments/issue-003-missing-mcp-tool-registration.md`
- FastMCP documentation: https://github.com/jlowin/fastmcp
- MCP protocol spec: https://spec.modelcontextprotocol.io/
- Story 6.2: `docs/stories/6.2.get-endpoint-categories-mcp-method.md` (original implementation)

---

## Technical Review Notes (SM Bob - 2025-10-01)

**Quality Score: 0/100** ❌❌❌❌❌

⚠️ **CRITICAL: STORY IS COMPLETELY INVALID** ⚠️

**Epic 9 is based on FALSE ASSUMPTIONS about the codebase:**

1. ❌ **FastMCP Framework NOT USED:**
   - Story assumes: `@mcp.tool()` decorator from FastMCP
   - **Actual code**: Uses native MCP SDK `from mcp import types, Server`
   - **Impact**: ENTIRE STORY IS WRONG - decorator approach doesn't exist

2. ✅ **getEndpointCategories IS ALREADY REGISTERED:**
   - Code evidence (mcp_server_v2.py:267-297):
   ```python
   types.Tool(
       name="getEndpointCategories",
       description="Retrieve hierarchical catalog...",
       inputSchema={...}
   )
   ```
   - Method handler exists (lines 344-347, 1569-1604)
   - **Tool is fully implemented and registered**

3. ❌ **Problem DOES NOT EXIST:**
   - Epic claims: "getEndpointCategories missing from tools list"
   - **Reality**: Tool IS registered in native MCP SDK pattern
   - **Likely cause of issue**: Different problem (database, configuration, deployment)

**Actual MCP Architecture:**

```python
# NOT FastMCP - Native MCP SDK approach
from mcp.server import Server
from mcp import types

server = Server("swagger-mcp-server")

# Tools registered via types.Tool list
@server.list_tools()
async def list_tools() -> list[types.Tool]:
    return [
        types.Tool(name="searchEndpoints", ...),
        types.Tool(name="getSchema", ...),
        types.Tool(name="getExample", ...),
        types.Tool(name="getEndpointCategories", ...),  # ✅ ALREADY HERE
    ]

# Method routing done manually
@server.call_tool()
async def call_tool(name: str, arguments: dict):
    if name == "getEndpointCategories":
        return await self._get_endpoint_categories_with_resilience(arguments)
```

**Implementation Readiness:** ❌ **STORY MUST BE COMPLETELY REWRITTEN**

**Root Cause Investigation Needed:**
1. Check if server actually starts and registers tools
2. Verify Claude Desktop configuration pointing to correct server
3. Check production logs for actual error (not registration issue)
4. Verify database has categories (Issue #002 dependency)
5. Check if it's a deployment/environment issue

**Recommendation:**
1. ❌ **DO NOT IMPLEMENT THIS STORY AS WRITTEN**
2. ✅ Investigate actual root cause (likely deployment/config/database)
3. ✅ Rewrite Epic 9 based on actual problem
4. ✅ Or close Epic 9 if getEndpointCategories already works
