# Story 9.2: Regenerate Servers and Validate MCP Protocol Integration

## Status
**BLOCKED - Needs Investigation and Rewrite**

**Reason:** Story depends on invalid Story 9.1
**Blocked By:** Epic 9 investigation checklist must be completed first
**Action Required:** Product Owner/Analyst to complete investigation, then rewrite or close story
**Previous Status:** ~~Ready for Development~~ (invalidated by technical review)

## Story

**As a** MCP server user,
**I want** generated MCP servers to include getEndpointCategories automatically,
**so that** all generated servers have the registration fix without manual intervention.

## Story Context

**Existing System Integration:**

- Integrates with: Swagger → MCP conversion, template generation, MCP protocol
- Technology: Python 3.11+, MCP SDK, generated server instances
- Follows pattern: Server generation from templates, MCP protocol validation
- Touch points:
  - Story 9.1 complete (@mcp.tool() decorator added)
  - `generated-mcp-servers/ozon-mcp-server/` regeneration
  - MCP tools/list and tools/call protocol methods

## Acceptance Criteria

**Functional Requirements:**

1. Ozon MCP server regenerated with registration fix
2. Generated server.py includes @mcp.tool() decorator
3. tools/list returns 4 tools (includes getEndpointCategories)
4. Method callable via MCP tools/call protocol
5. MCP response format valid and complete

**Quality Requirements:**

6. MCP protocol integration tests pass
7. No errors in server logs
8. Generated server passes validation

## Tasks / Subtasks

- [ ] **Task 1: Regenerate Ozon MCP Server**
  - [ ] Run: `poetry run swagger-mcp-server convert swagger-openapi-data/swagger.json -o generated-mcp-servers/ozon-mcp-server --force`
  - [ ] Verify generated server.py includes decorator
  - [ ] Check getEndpointCategories method present
  - [ ] Verify no generation errors

- [ ] **Task 2: Test tools/list Protocol**
  - [ ] Start generated server
  - [ ] Send tools/list request
  - [ ] Verify 4 tools in response
  - [ ] Verify getEndpointCategories present

- [ ] **Task 3: Test tools/call Protocol**
  - [ ] Send tools/call for getEndpointCategories
  - [ ] Test with include_counts=true
  - [ ] Test with include_methods=true
  - [ ] Verify response format

- [ ] **Task 4: MCP Protocol Integration Tests**
  - [ ] Create test_integration/test_mcp_protocol_get_categories.py
  - [ ] Test tools/list includes getEndpointCategories
  - [ ] Test tools/call executes successfully
  - [ ] Test error handling (empty database scenario)

- [ ] **Task 5: Validation**
  - [ ] Check server logs for errors
  - [ ] Verify no MCP protocol violations
  - [ ] Test with MCP client simulator
  - [ ] Document results

## Implementation Details

### MCP Protocol Test

```python
@pytest.mark.asyncio
async def test_tools_list_includes_get_endpoint_categories(mcp_server):
    """Verify getEndpointCategories in tools/list response"""
    response = await mcp_server.request("tools/list", {})

    tools = response["result"]["tools"]
    tool_names = [t["name"] for t in tools]

    assert "getEndpointCategories" in tool_names
    assert len(tool_names) == 4

@pytest.mark.asyncio
async def test_tools_call_get_endpoint_categories(mcp_server):
    """Verify getEndpointCategories callable via MCP"""
    response = await mcp_server.request("tools/call", {
        "name": "getEndpointCategories",
        "arguments": {
            "include_counts": True,
            "include_methods": True
        }
    })

    assert "result" in response
    assert not response.get("error")
    # Note: May be empty if Issue #002 not fixed
```

## Dependencies

**Depends On:**
- Story 9.1 - Decorator must be added first

**Blocks:**
- Story 9.3 - End-to-end testing

## Definition of Done

- [x] Ozon MCP server regenerated
- [x] Generated code includes decorator
- [x] tools/list returns 4 tools
- [x] tools/call works correctly
- [x] MCP protocol tests pass
- [x] No server errors

## Related Files

**Regenerated:**
- `generated-mcp-servers/ozon-mcp-server/server.py`

**New:**
- `src/tests/integration/test_mcp_protocol_get_categories.py`

## References

- Epic: `docs/stories/epic-9-getendpointcategories-registration-fix.md`
- Story 9.1: `docs/stories/9.1.add-mcp-tool-decorator-validation.md`

---

## Technical Review Notes (SM Bob - 2025-10-01)

**Quality Score: 0/100** ❌❌❌❌❌

⚠️ **CRITICAL: STORY IS BASED ON FALSE PREMISE** ⚠️

**This story depends on Story 9.1 which is completely invalid.**

**Findings:**
- ❌ Story assumes decorator needs to be added (Story 9.1)
- ✅ **Tool is ALREADY registered** in native MCP SDK
- ❌ Server regeneration won't fix non-existent problem
- ❌ MCP protocol tests would likely PASS already

**Implementation Readiness:** ❌ **DO NOT IMPLEMENT - DEPENDS ON INVALID STORY 9.1**

**Recommendation:**
1. ❌ **DO NOT PROCEED** until Story 9.1 is investigated/rewritten
2. ✅ Test if getEndpointCategories ALREADY works in generated servers
3. ✅ If it works, close this story as unnecessary
4. ✅ If it doesn't work, investigate REAL root cause
