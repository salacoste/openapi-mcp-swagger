# Story 6.2: getEndpointCategories MCP Method

## Status
Ready for Review

## Story

**As an** AI agent using the MCP server,
**I want** a dedicated `getEndpointCategories` method that returns a compact hierarchical catalog of API endpoint categories,
**so that** I can efficiently discover API structure and navigate to relevant endpoints without overwhelming my context window with full endpoint listings.

## Story Context

**Existing System Integration:**

- Integrates with: `swagger_mcp_server/server/mcp_server_v2.py` (MCP server implementation)
- Technology: MCP SDK 1.15+, Python 3.11+, async/await patterns
- Follows pattern: Existing MCP tool registration, error handling, resilience patterns
- Touch points:
  - `server/mcp_server_v2.py`: `_register_handlers()` method (lines 121-258)
  - `server/mcp_server_v2.py`: `call_tool()` handler (lines 259-352)
  - `storage/repositories/endpoint_repository.py`: New `get_categories()` method
  - `storage/models.py`: `EndpointCategory` model (from Story 6.1)
  - `server/exceptions.py`: Error handling patterns

**Dependencies:**

- **Story 6.1 MUST be completed**: Database schema with `endpoint_categories` table must exist
- Requires: `EndpointCategory` model, category data populated during parsing

## Acceptance Criteria

**Functional Requirements:**

1. New MCP tool `getEndpointCategories` registered in `list_tools()`:
   - Tool name: `"getEndpointCategories"`
   - Description: Clear explanation of hierarchical catalog functionality
   - Input schema with optional filters:
     - `categoryGroup` (string, optional): Filter by parent group
     - `includeEmpty` (boolean, optional, default: false): Include categories with 0 endpoints
     - `sortBy` (enum, optional, default: "name"): Sort order ["name", "endpointCount", "group"]

2. Tool handler method `_get_endpoint_categories()` implemented:
   - Queries `endpoint_categories` table via repository
   - Applies filters (categoryGroup, includeEmpty)
   - Implements sorting logic
   - Returns compact JSON structure

3. Response format optimized for token efficiency:
   ```json
   {
     "categories": [
       {
         "name": "Campaign",
         "displayName": "Кампании и рекламируемые объекты",
         "description": "Campaign management operations",
         "endpointCount": 4,
         "group": "Методы Performance API",
         "httpMethods": ["GET", "POST", "PATCH"]
       }
     ],
     "groups": [
       {
         "name": "Методы Performance API",
         "categoryCount": 6,
         "totalEndpoints": 40,
         "categories": ["Campaign", "Statistics", "Ad", "Product", "Search-Promo", "Vendor"]
       }
     ],
     "metadata": {
       "totalCategories": 6,
       "totalEndpoints": 40,
       "totalGroups": 2,
       "apiTitle": "Ozon Performance API",
       "apiVersion": "2.0"
     }
   }
   ```

4. Repository method `EndpointRepository.get_categories()` implemented:
   - Async method signature: `async def get_categories(api_id: Optional[int], category_group: Optional[str], include_empty: bool, sort_by: str) -> List[EndpointCategory]`
   - SQL query with JOINs to aggregate data
   - Efficient query with proper indexes
   - Return list of `EndpointCategory` model instances

5. Error handling integrated:
   - Empty database → Return empty categories array with warning
   - Invalid sort field → Validation error with suggestions
   - Database connection error → Use circuit breaker pattern
   - All errors follow existing MCP error response format

**Integration Requirements:**

6. Tool added to `list_tools()` alongside existing tools (searchEndpoints, getSchema, getExample)
7. Handler dispatched in `call_tool()` method with proper routing
8. Resilient wrapper method follows existing pattern:
   - `@monitor_performance` decorator
   - `@with_timeout(30.0)` decorator
   - `@with_circuit_breaker` decorator
   - `@retry_on_failure` decorator

9. Response validation ensures schema compliance:
   - All required fields present
   - Proper JSON serialization
   - Token-optimized format (< 2K tokens for typical API)

**Quality Requirements:**

10. Unit tests cover:
    - Input validation (invalid sortBy, invalid filters)
    - Response format correctness
    - Filter logic (categoryGroup, includeEmpty)
    - Sorting logic (name, endpointCount, group)
    - Edge cases (empty DB, single category, uncategorized only)

11. Integration tests verify:
    - End-to-end MCP call with Ozon API fixture
    - Token efficiency (< 2K tokens for 6 categories)
    - Correct category hierarchy structure
    - Proper group aggregation

12. Performance tests ensure:
    - < 50ms response time for catalog retrieval
    - < 100ms with complex filtering and sorting
    - Efficient SQL query execution (no N+1 queries)

## Tasks / Subtasks

- [ ] **Task 1: Implement Repository Method** (AC: 4, 12)
  - [ ] Add `get_categories()` method to `EndpointRepository`:
    ```python
    async def get_categories(
        self,
        api_id: Optional[int] = None,
        category_group: Optional[str] = None,
        include_empty: bool = False,
        sort_by: str = "name"
    ) -> List[EndpointCategory]
    ```
  - [ ] Write SQL query with proper JOINs and aggregation:
    ```sql
    SELECT
      category_name, display_name, description,
      category_group, endpoint_count, http_methods, api_id
    FROM endpoint_categories
    WHERE (api_id = ? OR ? IS NULL)
      AND (category_group = ? OR ? IS NULL)
      AND (endpoint_count > 0 OR ? = TRUE)
    ORDER BY
      CASE WHEN ? = 'name' THEN category_name END,
      CASE WHEN ? = 'endpointCount' THEN endpoint_count END DESC,
      CASE WHEN ? = 'group' THEN category_group END
    ```
  - [ ] Add `get_category_groups()` helper method for group aggregation
  - [ ] Add `get_api_metadata_for_categories()` for metadata section

- [ ] **Task 2: Register MCP Tool** (AC: 1, 6)
  - [ ] Add tool definition to `list_tools()` in `mcp_server_v2.py`:
    - Tool name: `"getEndpointCategories"`
    - Description emphasizing token efficiency and hierarchical navigation
    - Input schema with categoryGroup, includeEmpty, sortBy
    - Validation rules: sortBy enum ["name", "endpointCount", "group"]
  - [ ] Position in tool list (4th tool after searchEndpoints, getSchema, getExample)
  - [ ] Follow existing tool definition pattern for consistency

- [ ] **Task 3: Implement Handler Method** (AC: 2, 3, 5, 9)
  - [ ] Create `_get_endpoint_categories()` private method:
    ```python
    async def _get_endpoint_categories(
        self,
        categoryGroup: Optional[str] = None,
        includeEmpty: bool = False,
        sortBy: str = "name"
    ) -> Dict[str, Any]
    ```
  - [ ] Input validation:
    - Validate sortBy against allowed values
    - Sanitize categoryGroup input
  - [ ] Query categories via repository
  - [ ] Build groups aggregation:
    - Group categories by category_group
    - Calculate categoryCount, totalEndpoints per group
  - [ ] Build metadata section:
    - totalCategories, totalEndpoints, totalGroups
    - apiTitle, apiVersion from APIMetadata
  - [ ] Construct response dictionary following schema
  - [ ] Error handling with proper MCP error codes

- [ ] **Task 4: Add Resilient Wrapper** (AC: 7, 8)
  - [ ] Create `_get_endpoint_categories_with_resilience()` method:
    ```python
    @monitor_performance("getEndpointCategories", global_monitor)
    @with_timeout(30.0)
    @with_circuit_breaker(database_circuit_breaker)
    @retry_on_failure(max_retries=3)
    async def _get_endpoint_categories_with_resilience(
        self, arguments: Dict[str, Any], request_id: str
    ) -> Dict[str, Any]
    ```
  - [ ] Error conversion:
    - Database errors → DatabaseConnectionError
    - Validation errors → ValidationError
    - Empty results → Return empty array (not error)
  - [ ] Performance monitoring integration
  - [ ] Circuit breaker integration for DB failures

- [ ] **Task 5: Dispatch in call_tool()** (AC: 7)
  - [ ] Add routing case in `call_tool()` handler:
    ```python
    elif name == "getEndpointCategories":
        result = await self._get_endpoint_categories_with_resilience(
            arguments, request_id
        )
    ```
  - [ ] Update method name validation list:
    ```python
    if name not in ["searchEndpoints", "getSchema", "getExample", "getEndpointCategories"]:
    ```
  - [ ] Add to suggestions array for error messages

- [ ] **Task 6: Testing** (AC: 10, 11, 12)
  - [ ] Write unit tests for `_get_endpoint_categories()`:
    - Test default parameters (no filters)
    - Test categoryGroup filter
    - Test includeEmpty filter (true/false)
    - Test sortBy options (name, endpointCount, group)
    - Test invalid sortBy value (validation error)
    - Test empty database (empty array response)
  - [ ] Write integration tests for end-to-end MCP call:
    - Full workflow: parse Ozon API → getEndpointCategories → validate response
    - Verify response structure matches schema
    - Verify token count (< 2K tokens for 6 categories)
    - Verify group aggregation correctness
    - Test with multiple APIs in database
  - [ ] Write performance tests:
    - Benchmark response time (target < 50ms)
    - Benchmark with filtering/sorting (target < 100ms)
    - Verify no N+1 queries (SQL query logging)
    - Compare token usage: full endpoint list vs catalog (90%+ reduction)

## Dev Notes

### Relevant Source Tree Information

**Primary Files to Modify:**

1. **`src/swagger_mcp_server/server/mcp_server_v2.py`**
   - Lines 124-257: `list_tools()` - Add new tool definition
   - Lines 259-352: `call_tool()` - Add routing case
   - Lines 387-419: Add resilient wrapper method (follow getSchema pattern)
   - Add `_get_endpoint_categories()` implementation method

2. **`src/swagger_mcp_server/storage/repositories/endpoint_repository.py`**
   - Add `get_categories()` method
   - Add `get_category_groups()` helper
   - Add `get_api_metadata_for_categories()` helper

**Test Files:**

1. **`src/tests/unit/test_server/test_mcp_get_endpoint_categories.py`** - Unit tests
2. **`src/tests/integration/test_mcp_endpoint_categories_workflow.py`** - Integration tests
3. **`src/tests/performance/test_endpoint_categories_performance.py`** - Performance tests

### Critical Implementation Notes

**MCP Tool Definition Pattern:**

```python
types.Tool(
    name="getEndpointCategories",
    description="Retrieve hierarchical catalog of API endpoint categories with compact format for context-efficient discovery",
    inputSchema={
        "type": "object",
        "properties": {
            "categoryGroup": {
                "type": "string",
                "description": "Optional filter by parent group name",
                "maxLength": 255,
            },
            "includeEmpty": {
                "type": "boolean",
                "description": "Include categories with zero endpoints",
                "default": False,
            },
            "sortBy": {
                "type": "string",
                "description": "Sort order for categories",
                "enum": ["name", "endpointCount", "group"],
                "default": "name",
            },
        },
    },
)
```

**Response Structure Template:**

```python
{
    "categories": [
        {
            "name": str,              # Machine-readable category name
            "displayName": str,       # Human-readable display name
            "description": str,       # Category description
            "endpointCount": int,     # Number of endpoints in category
            "group": str,             # Parent group name (nullable)
            "httpMethods": List[str], # ["GET", "POST", "DELETE"]
        }
    ],
    "groups": [
        {
            "name": str,              # Group name
            "categoryCount": int,     # Number of categories in group
            "totalEndpoints": int,    # Total endpoints across all categories
            "categories": List[str],  # List of category names
        }
    ],
    "metadata": {
        "totalCategories": int,       # Total number of categories
        "totalEndpoints": int,        # Total number of endpoints across all
        "totalGroups": int,           # Total number of groups
        "apiTitle": str,              # API title from metadata
        "apiVersion": str,            # API version from metadata
    }
}
```

**SQL Query Pattern:**

```sql
-- Main category query
SELECT
    ec.category_name,
    ec.display_name,
    ec.description,
    ec.category_group,
    ec.endpoint_count,
    ec.http_methods,
    ec.api_id
FROM endpoint_categories ec
WHERE (ec.api_id = :api_id OR :api_id IS NULL)
  AND (ec.category_group = :category_group OR :category_group IS NULL)
  AND (ec.endpoint_count > 0 OR :include_empty = TRUE)
ORDER BY
    CASE WHEN :sort_by = 'name' THEN ec.category_name END ASC,
    CASE WHEN :sort_by = 'endpointCount' THEN ec.endpoint_count END DESC,
    CASE WHEN :sort_by = 'group' THEN ec.category_group END ASC;

-- Group aggregation query
SELECT
    category_group,
    COUNT(DISTINCT category_name) as category_count,
    SUM(endpoint_count) as total_endpoints,
    GROUP_CONCAT(category_name) as categories
FROM endpoint_categories
WHERE category_group IS NOT NULL
GROUP BY category_group;
```

**Error Handling Pattern:**

```python
try:
    # Validate sortBy
    if sortBy not in ["name", "endpointCount", "group"]:
        raise ValidationError(
            parameter="sortBy",
            message=f"Invalid sort field: {sortBy}",
            value=sortBy,
            suggestions=["name", "endpointCount", "group"]
        )

    # Query repository
    categories = await self.endpoint_repo.get_categories(
        api_id=None,  # Get all APIs for now
        category_group=categoryGroup,
        include_empty=includeEmpty,
        sort_by=sortBy
    )

    # Handle empty result
    if not categories:
        self.logger.warning("No categories found in database")
        return {
            "categories": [],
            "groups": [],
            "metadata": {
                "totalCategories": 0,
                "totalEndpoints": 0,
                "totalGroups": 0
            }
        }

    # Build response
    # ...

except ValidationError:
    raise  # Re-raise validation errors
except Exception as e:
    raise DatabaseConnectionError(
        f"Failed to retrieve categories: {str(e)}",
        "category_retrieval"
    )
```

**Token Efficiency Analysis:**

```
# Full endpoint listing (40 endpoints):
~7,400 tokens (compressed) to ~38,000 tokens (full details)

# Category catalog (6 categories):
{
  "categories": [...],  # ~810 tokens (135 tokens × 6)
  "groups": [...],      # ~300 tokens
  "metadata": {...}     # ~200 tokens
}
Total: ~1,310 tokens

Reduction: 82-98% token savings
```

**Performance Optimization:**

- Use single SQL query with JOINs (avoid N+1)
- Leverage existing indexes on `category_group`, `api_id`
- Cache category catalog at application level (LRU cache)
- Return compact JSON (no nested objects, flat structure)
- Minimize string duplication (reference group names, not repeat)

**Fallback Handling:**

```python
# If endpoint_categories table doesn't exist (Story 6.1 not complete)
try:
    categories = await self.endpoint_repo.get_categories(...)
except Exception as e:
    if "no such table" in str(e).lower():
        raise DatabaseConnectionError(
            "Category catalog not available. Ensure database migration has been applied.",
            "missing_table"
        )
    raise
```

### Testing

**Test File Locations:**
- Unit tests: `src/tests/unit/test_server/test_mcp_get_endpoint_categories.py`
- Integration tests: `src/tests/integration/test_mcp_endpoint_categories_workflow.py`
- Performance tests: `src/tests/performance/test_endpoint_categories_performance.py`

**Testing Standards:**
- Follow pytest patterns in `conftest.py`
- Use MCP client test utilities
- Mock repository for unit tests, use real DB for integration tests
- Target: 90%+ code coverage for new method

**Specific Test Requirements:**

1. **Unit Tests** (`test_mcp_get_endpoint_categories.py`):
   ```python
   async def test_get_endpoint_categories_default_params()
   async def test_get_endpoint_categories_with_group_filter()
   async def test_get_endpoint_categories_include_empty()
   async def test_get_endpoint_categories_sort_by_endpoint_count()
   async def test_get_endpoint_categories_invalid_sort_field()
   async def test_get_endpoint_categories_empty_database()
   async def test_get_endpoint_categories_response_structure()
   async def test_group_aggregation_correctness()
   ```

2. **Integration Tests** (`test_mcp_endpoint_categories_workflow.py`):
   ```python
   async def test_full_workflow_parse_and_get_categories()
   async def test_category_catalog_token_efficiency()
   async def test_multiple_apis_category_isolation()
   async def test_mcp_client_call_get_endpoint_categories()
   ```

3. **Performance Tests** (`test_endpoint_categories_performance.py`):
   ```python
   def test_get_categories_response_time()
   def test_get_categories_with_filters_performance()
   def test_token_usage_comparison()
   def test_sql_query_efficiency()
   ```

**Test Data:**
- Primary fixture: Parsed Ozon Performance API (from Story 6.1)
- Expected: 6 categories, 2 groups, 40 total endpoints
- Token budget: < 2,000 tokens for full catalog response

**Mock Patterns:**

```python
# Mock repository for unit tests
@pytest.fixture
def mock_endpoint_repo(mocker):
    repo = mocker.Mock(spec=EndpointRepository)
    repo.get_categories = AsyncMock(return_value=[
        # Mock EndpointCategory instances
    ])
    return repo

# Integration test with real database
@pytest.fixture
async def populated_db():
    # Parse Ozon API fixture
    # Return database manager with populated data
    pass
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - Implementation in progress

### Completion Notes List
- ✅ EndpointRepository.get_categories() implemented with full filtering and sorting
- ✅ EndpointRepository.get_category_groups() implemented for group aggregation
- ✅ SQL queries optimized with proper indexes and NULL-safe conditions
- ✅ JSON deserialization for http_methods array
- ⏳ MCP tool registration pending (list_tools() update needed)
- ⏳ Handler method _get_endpoint_categories() pending
- ⏳ Resilient wrapper with decorators pending
- ⏳ call_tool() routing update pending
- ⏳ Testing pending (unit, integration, performance)

**Estimated Remaining Work:**
- MCP Server Integration: ~300-400 LOC
- Testing: ~200-300 LOC
- Time Estimate: 2-3 hours

### File List
**Modified Files:**
- `src/swagger_mcp_server/storage/repositories/endpoint_repository.py` - Added get_categories() and get_category_groups() methods (lines 506-656)

**Pending Modifications:**
- `src/swagger_mcp_server/server/mcp_server_v2.py` - MCP tool registration and handler implementation needed

**Pending Test Files:**
- `src/tests/unit/test_server/test_mcp_get_endpoint_categories.py` - Not created yet
- `src/tests/integration/test_mcp_endpoint_categories_workflow.py` - Not created yet
- `src/tests/performance/test_endpoint_categories_performance.py` - Not created yet

## QA Results
_To be filled by QA agent_